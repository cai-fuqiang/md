#!/bin/sh
CUR_KVER=`uname -r`
RESTORE_KERNEL_PATH=/root/escloud_image_backup

kver_before_611()
{
        local KVER=$1
        if [ "$(echo $KVER |grep -E '4.18.0-147.5.1.es8_|4.18.0-372')" == "" ];then
                return 1
        else
		return 0
        fi
}

kver_before_es8()
{
        if [ "$(echo $KVER |grep -E '4.18.0-147|4.18.0-372')"  == "" ];then
                return 1
        else
                return 0
        fi
}

rpm_remove()
{
        local KVER=$1
        echo yum remove kernel $KVER beg
	kver_before_es8 $KVER

        if [ $? -eq 0 ];then
                yum remove kernel-core-$KVER -y
		yum remove2
        else
                yum remove kernel-$KVER -y
        fi

	if [[ $? -eq 0 ]];then
        	echo yum remove kernel $KVER done
	else
		echo yum remove kernel $KVER failed, need direct remove!!!!!
		direct_mv $KVER
	fi
}

direct_mv()
{
        local KVER=$1
        RESTORE_PATH=$RESTORE_KERNEL_PATH/$KVER
        echo direct remove kernel $KVER to $RESTORE_PATH
        mkdir -p $RESTORE_PATH
        mv /boot/*$KVER* $RESTORE_PATH
}

remove_kernel()
{
        local KVER=$1

	echo remove kernel $KVER

	kver_before_611 $CUR_KVER

	if [[ $? -eq 1 ]];then
                rpm_remove $KVER
		return
	fi

	kver_before_611 $KVER
        if [[ $? -eq 0 ]];then
		echo $kver=== $KVER
                rpm_remove $KVER
        else
                direct_mv $KVER
        fi
}

get_kernel_num()
{
        cd /boot
        ls vmlinuz-* |grep -v rescue |wc -l
        cd - > /dev/null
}

delete_kdump_initramfs()
{
	rm -f /boot/initramfs-*kdump.img
}

main()
{
	echo "delete kdump initrd"
	delete_kdump_initramfs
	KERNEL_NUM=$(get_kernel_num)
	if [[ $KERNEL_NUM -eq 1 ]];then
                echo boot space is enough, need not remove any kernel
                exit
        fi
        echo the number of kernel is $KERNEL_NUM, need  remove to keep number to 1

        cd /boot

        for VMLINUZ_KVER in `ls vmlinuz-* |grep -v rescue |grep -v $CUR_KVER`
        do
                remove_kernel ${VMLINUZ_KVER#vmlinuz-}
        done

        cd - > /dev/null
}

main
