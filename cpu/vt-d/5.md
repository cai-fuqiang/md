# 5 Interrupt Remapping and Interrupt Posting
This chapter discuss architecture and hardware details for 
interrupt-remapping and interrupt-posting.  
## 5.1 Interrupt Remapping 
The interrupt-remapping architecture enables system software 
to control and censor external interrupt requests generated 
by all sources including those from interrupt controllers 
(I/OxAPICs), MSI/MSI-X capable devices including endpoints, 
root-ports and Root-Complex integrated end-points. Interrupts
generated by the remapping hardware itself (Fault Event and 
Invalidation Completion Events) are not subject to interrupt 
remapping. Interrupt requests appear to the Root-Complex as 
upstream memory write requests to the interrupt- address-range
0xFEEX_XXXXh. Since interrupt requests arrive at the 
Root-Complex as write requests, interrupt-remapping is co-located
with the remapping hardware units. The interrupt-remapping 
capability is reported through the Extended Capability Register.

### 5.1.1 Identifying Origination of Interrupt Requests
To support domain-isolation usages, the platform hardware must
be capable of uniquely identifying the requestor (Source-Id) 
for each interrupt message. The interrupt sources in a 
platform and use of source-id in these requests may be 
categorized as follows:

* Message Signaled Interrupts from PCI-Express Devices
	+ For message-signaled interrupt requests from PCI-Express 
	devices, the source-id is the requester identifier in the 
	PCI-Express transaction header. The requester-id of a device
	is composed of its PCI Bus/Device/Function number assigned 
	by configuration software an uniquely identifies the hardware
	function that initiated the I/O request. Section 3.4.1 
	illustrates the requester-id as defined by the PCI-Express 
	specification. Section 3.9.4 describes use of source-id 
	field by PCI-Express devices using phantom functions.
*  Message Signaled Interrupts from Root-Complex Integrated Devices
	+ For message-signaled interrupt requests from root-complex 
	integrated PCI or PCI-Express devices, the source-id is its 
	PCI requester-id.
* Message Signaled Interrupts from Devices behind PCI-Express
to PCI/PCI-X Bridges
	+ For message-signaled interrupt requests from devices behind
	PCI-Express-to-PCI/PCI-X bridges, the requester identifier 
	in those interrupt requests may be that of the interrupting 
	device or the requester-id with the bus number field equal 
	to the bridge’s secondary interface’s bus number and device 
	and function number fields value of zero. Section 3.9.1 
	describes legacy behavior of these bridges. Due to this aliasing,
	interrupt-remapping hardware does not isolate interrupts from
	individual devices behind such bridges.
* Message Signaled Interrupts from Devices behind Conventional
 PCI bridges
	+ For message-signaled interrupt requests from devices behind
	conventional PCI bridges, the source-id in those interrupt 
	requests is the requestor-id of the legacy bridge device. 
	Section 3.9.2 describes legacy behavior of these bridges. 
	Due to this, interrupt-remapping hardware does not isolate 
	message-signaled interrupt requests from individual devices 
	behind such bridges.
* Legacy pin interrupts
	+ For devices that use legacy methods for interrupt routing 
	(such as either through direct wiring to the I/OxAPIC input 
	pins, or through INTx messages), the I/OxAPIC hardware 
	generates the interrupt-request transaction. To identify the
	source of interrupt requests generated by I/OxAPICs, the 
	interrupt-remapping hardware requires each I/OxAPIC in the 
	platform (enumerated through the ACPI Multiple APIC Descriptor
	Tables (MADT)) to include a unique 16-bit source-id in its 
	requests. BIOS reports the source-id for these I/OxAPICs via
	ACPI structures to system software. Refer to Section 8.3.1.1
	for more details on I/OxAPIC identity reporting. 
* Other Message Signaled Interrupts
	 * For any other platform devices that are not PCI discoverable
	 and yet capable of generating message-signaled interrupt 
	 requests (such as the integrated High Precision Event Timer -
	 HPET devices), the platform must assign unique source-ids 
	 that do not conflict with any other source-ids on the 
	 platform. BIOS must report the 16-bit source-id for these 
	 via ACPI structures described in Section 8.3.1.2.

### 5.1.2 Interrupt Request Formats On Intel® 64 Platforms
Interrupt-remapping on Intel® 64 platforms support two interrupt
request formats. These are described in the following sub-sections.

#### 5.1.2.1 Interrupt Requests in Compatibility Format
Figure 5-14 illustrates the interrupt request in Compatibility
format. The Interrupt Format field (Address bit 4) is Clear 
in Compatibility format requests. Refer to the Intel® 64 
Architecture software developer’s manuals for details on other
fields in the Compatibility format interrupt requests. Platforms
without interrupt-remapping capability support only Compatibility
format interrupts.

![Figure-5-14](pic/Figure-5-14.png)

#### 5.1.2.2 Interrupt Requests in Remappable Format
Figure 5-15 illustrates the Remappable interrupt request 
format. The Interrupt Format field (Address bit 4) is Set for
Remappable format interrupt requests. Remappable interrupt 
requests are applicable only on platforms with interrupt-remapping
support.

![Figure-5-15](pic/Figure-5-15.png)

Table 6 describes the various address fields in the Remappable
interrupt request format.

### 5.1.3 Interrupt Remapping Table
Interrupt-remapping hardware utilizes a memory-resident 
single-level table, called the Interrupt Remapping Table. 
The interrupt remapping table is expected to be setup by 
system software, and its base address and size is specified 
through the Interrupt Remap Table Address Register. Each entry
in the table is 128-bits in size and is referred to as Interrupt
Remapping Table Entry (IRTE).Section 9.10 illustrates the IRTE
format.

For interrupt requests in Remappable format, the interrupt-remapping
hardware computes the ‘interrupt_index’ as below. The Handle, SHV
and Subhandle are respective fields from the interrupt address
and data per the Remappable interrupt format. 
```
if (address.SHV == 0) {
	interrupt_index = address.handle;
} else {
	interrupt_index = (address.handle + data.subhandle);
}
```
The Interrupt Remap Table Address Register is programmed by 
software to specify the number of IRTEs in the Interrupt 
Remapping Table (maximum number of IRTEs in an Interrupt 
Remapping Table is 64K). Remapping hardware units in the 
platform may be configured to share interrupt-remapping table
or use independent tables. The interrupt_index is used to 
index the appropriate IRTE in the interrupt-remapping table. 
If the interrupt_index value computed is equal to or larger 
than the number of IRTEs in the remapping table, hardware 
treats the interrupt request as error.

Unlike the Compatibility interrupt format where all the interrupt
attributes are encoded in the interrupt request address/data,
the Remappable interrupt format specifies only the fields needed
to compute the interrupt_index. The attributes of the remapped
interrupt request is specified through the IRTE referenced by
the interrupt_index.The interrupt-remapping architecture defines
support for hardware to cache frequently used IRTEs for improved
performance. For usages where software may need to dynamically
update the IRTE, architecture defines commands to invalidate
the IEC. Chapter 6 describes the caching constructs and associated
invalidation commands. 

### 5.1.4 Interrupt-Remapping Hardware Operation
The following provides a functional overview of the 
interrupt-remapping hardware operation:

* An interrupt request is identified by hardware as a DWORD 
sized write request to interrupt address ranges 0xFEEx_xxxx.
* When interrupt-remapping is not enabled (IRES field Clear 
in Global Status Register), all interrupt requests are processed
per the Compatibility interrupt request format described in 
Section 5.1.2.1.

* When interrupt-remapping is enabled (IRES field Set in Global
Status Register), interrupt requests are processed as follows:
	+ Interrupt requests in the Compatibility format (i.e requests
	with Interrupt Format field Clear) are processed as follows:
		* If Extended Interrupt Mode is enabled (EIME field in 
		Interrupt Remapping Table Address Register is Set), or if 
		the Compatibility format interrupts are disabled (CFIS 
		field in the Global Status Register is Clear), the 
		Compatibility format interrupts are blocked.
		* Else, Compatibility format interrupts are processed as
		pass-through (bypasses interrupt-remapping).
	+ Interrupt requests in the Remappable format (i.e. request with
	Interrupt Format field Set) are processed as follows:
		* The reserved fields in the Remappable interrupt requests are
		checked to be zero. If the reserved field checking fails, 
		the interrupt request is blocked. Else, the Source-id, Handle,
		SHV, and Subhandle fields are retrieved from the interrupt 
		request.
		* Hardware computes the interrupt_index per the algorithm 
		described in Section 5.1.3. The computed interrupt_index is
		validated to be less than the interrupt-remapping table size
		configured in the Interrupt Remap Table Address Register. If
		the bounds check fails, the interrupt request is blocked.
		* If the above bounds check succeeds, the IRTE corresponding
		to the interrupt_index value is either retrieved from the 
		Interrupt Entry Cache, or fetched from the interrupt-remapping
		table. If the Coherent (C) field is reported as Clear in the
		Extended Capability Register, the IRTE fetch from memory will
		not snoop the processor caches. If the Present (P) field in the
		IRTE is Clear, the interrupt request is blocked and treated as
		fault.
		* If IRTE is present (P=1), hardware performs verification 
		of the interrupt requester per the programming of the SVT, 
		SID and SQ fields in the IRTE as described in Section 9.10. 
		If the source-id checking fails, the interrupt request is 
		blocked.
	+ If IRTE has Mode field clear (IM=0):1
		* Hardware interprets the IRTE in remappable format (as described in Section 9.10). If
invalid programming of remappable-format IRTE is detected, the interrupt request is
blocked.
		* If above checks succeed, a remapped interrupt request is generated per the programming
of the IRTE fields2.
* Any of the above checks that result in interrupt request to be blocked is treated as a interrupt-
remapping fault condition. The interrupt-remapping fault conditions are enumerated in the
following section.
#### 5.1.4.1 Interrupt Remapping Fault Conditions
The following table enumerates the various conditions resulting in faults when processing interrupt
requests. A fault conditions is treated as ‘qualified’ if the fault is reported to software only when the
Fault Processing Disable (FPD) field is Clear in the IRTE used to process the faulting interrupt request.
